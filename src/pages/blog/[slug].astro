---
import BaseLayout from "@layouts/BaseLayout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import ScrollProgress from "@components/ScrollProgress.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();
const baseUrl = Astro.site?.toString() ?? "https://www.it-experten24.de";
const canonical = `${baseUrl}/blog/${post.slug}`;
const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.data.title,
  description: post.data.excerpt,
  image: post.data.heroImage ? `${baseUrl}${post.data.heroImage}` : `${baseUrl}/images/blog-placeholder.webp`,
  datePublished: post.data.publishedAt,
  dateModified: post.data.updatedAt ?? post.data.publishedAt,
  author: {
    "@type": "Organization",
    name: "IT-Experten 24"
  },
  publisher: {
    "@type": "Organization",
    name: "IT-Experten 24",
    logo: {
      "@type": "ImageObject",
      url: `${baseUrl}/images/logo.svg`
    }
  },
  mainEntityOfPage: canonical
};
---

<BaseLayout
  title={post.data.title}
  description={post.data.excerpt}
  canonical={canonical}
  structuredData={structuredData}
>
  <Header />
  <ScrollProgress />
  <main class="bg-background py-16">
    <article class="mx-auto w-full max-w-3xl px-6">
      <span class="badge">Blog</span>
      <h1 class="mt-6 text-4xl font-semibold text-text">{post.data.title}</h1>
      <div class="mt-4 flex flex-wrap items-center gap-4 text-xs font-medium text-text/60">
        <span>Veröffentlicht am {new Date(post.data.publishedAt).toLocaleDateString("de-DE", { dateStyle: "long" })}</span>
        {post.data.updatedAt && (
          <span>Aktualisiert am {new Date(post.data.updatedAt).toLocaleDateString("de-DE", { dateStyle: "long" })}</span>
        )}
        {post.data.readingTime && <span>Lesedauer: {post.data.readingTime}</span>}
      </div>
      <figure class="mt-8 overflow-hidden rounded-3xl">
        <img src={post.data.heroImage ?? "/images/blog-placeholder.webp"} alt={post.data.title} class="h-auto w-full object-cover" loading="lazy" />
      </figure>
      <div class="prose prose-slate mt-8 max-w-none prose-headings:text-text prose-a:text-brand-primary prose-strong:text-text">
        <Content />
      </div>
      {headings.length > 0 && (
        <aside class="mt-12 rounded-3xl bg-white p-6 shadow-card">
          <h2 class="text-lg font-semibold text-text">Inhaltsverzeichnis</h2>
          <ul class="mt-4 space-y-2 text-sm text-text/70">
            {headings.filter((heading) => heading.depth <= 3).map((heading) => (
              <li>
                <a href={`#${heading.slug}`} class="hover:text-brand-primary">
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </aside>
      )}
      <div class="mt-12 flex flex-wrap gap-3 text-sm text-brand-primary">
        {post.data.tags?.map((tag) => (
          <span class="rounded-full bg-brand-primary/10 px-3 py-1">#{tag}</span>
        ))}
      </div>
      <div class="mt-12 rounded-3xl bg-white p-6 shadow-card">
        <h2 class="text-lg font-semibold text-text">Unterstützung in München sichern</h2>
        <p class="mt-2 text-sm text-text/70">
          Sie möchten die Schritte gemeinsam mit einer Expert:in durchführen? IT-Experten 24 hilft vor Ort in München oder per Fernwartung. Wir beraten Sie verständlich und nachhaltig.
        </p>
        <div class="mt-4 flex flex-wrap gap-3">
          <a href="/kontakt" class="btn-primary">Kontakt aufnehmen</a>
          <a href="tel:+4915733135928" class="btn-secondary">+49 157 3313 5928</a>
        </div>
      </div>
    </article>
  </main>
  <Footer />
</BaseLayout>
